version: 2.1

#orbs:
#  win: circleci/windows@1.0.0

commands:
  test_command:
    parameters:
      should_exit:
        type: boolean
        default: false
    steps:
      - run:
          name: "Test command"
          command: |
            echo "Test command"
            echo "Param: << parameters.should_exit >>"
            [ << parameters.should_exit >> = true ] && exit 1 || true
          shell: /bin/bash

  save_data_1:
    parameters:
      var1:
        type: string
    steps:
      - checkout
      - run: echo "Test 1"
      - restore_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
      - run:
          name: Build Voice CPP slave
          command: |
            echo "currenr dir: $(pwd)"
            cd ~
            echo "currenr dir-new: $(pwd)"
            mkdir -p test_dir
            echo "test-1" > test_dir/test_file.txt
            echo "var1: << parameters.var1 >>"
            echo "env_var: ${env_var}"
            echo "env_var: env_var"
            echo "env_var: $env_var"
            echo $BASH_ENV.test_var
            echo $BASH_ENV.$test_var
            echo $test_var
          shell: /bin/bash
      - save_cache:
          key: -v1-test-<< parameters.var1 >>-{{ .Revision }}
          paths:
            - "~/test_dir"
      - save_cache:
          key: -v1-test-{{ .Environment.test_var }}-{{ .Revision }}
          paths:
            - "~/test_dir"
      - save_cache:
          key: -v1-test-{{ .Environment.$test_var }}-{{ .Revision }}
          paths:
            - "~/test_dir"
      - save_cache:
          key: >
            -v1-test-{{ .Environment.$test_var }}-{{ .Revision }}
            -super-long-key-test-yaml-123-qwertyu-001
          paths:
            - "~/test_dir"
      - save_cache:
          key: >-
            -v1-test-{{ .Environment.$test_var }}-{{ .Revision }}
            -super-long-key-test-yaml-123-qwertyu-002
          paths:
            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-$test_var-{{ .Revision }}
#          paths:
#            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-$test_var-{{ .Revision }}
#          paths:
#            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-{$test_var}-{{ .Revision }}
#          paths:
#            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-{$test_var}-{{ .Revision }}
#          paths:
#            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-($test_var)-{{ .Revision }}
#          paths:
#            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-{{ $test_var }}-{{ .Revision }}
#          paths:
#            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-"$test_var"-{{ .Revision }}
#          paths:
#            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-"${test_var}"-{{ .Revision }}
#          paths:
#            - "~/test_dir"
#      - save_cache:
#          key: -v1-test-"{$BASH_ENV.$test_var}"-{{ .Revision }}
#          paths:
#            - "~/test_dir"

jobs:
  test_print:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - run:
          name: "Test print"
          command: |
            echo "Current user: $USER"
            echo "Who am I: $(whoami)"
          shell: /bin/bash
  call_command_1:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - run:
          name: "Call command"
          command: |
            echo "Call command"
      - test_command
  call_command_2:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - run:
          name: "Call command"
          command: |
            echo "Call command"
      - test_command:
          should_exit: false
  call_command_3:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - run:
          name: "Call command"
          command: |
            echo "Call command"
      - test_command:
          should_exit: true

  set_env_var:
    docker:
      - image: circleci/ruby:2.4.1
    environment:
      env_var_123: "env-var-1"
    steps:
      - run:
          name: "Set env var"
          command: |
            echo "env_var: ${env_var}"
            echo "export test_var=test-var-123" >> $BASH_ENV
            echo $BASH_ENV.test_var
            echo $BASH_ENV.$test_var
            echo $test_var
          shell: /bin/bash
      - save_data_1:
          var1: test-321

  save_data_2:
    docker:
      - image: circleci/redis:5.0.0-32bit
    steps:
      - checkout
      - run: echo "Test 2"
      - restore_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
      - run:
          name: Build Voice CPP slave
          command: |
            echo "currenr dir: $(pwd)"
            cd ~
            echo "currenr dir-new: $(pwd)"
            mkdir -p test_dir
            echo "test-2" > test_dir/test_file.txt
          shell: /bin/bash
      - save_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
          paths:
            - "~/test_dir"
  save_data_3:
    docker:
      - image: circleci/php:7.3.6
    steps:
      - checkout
      - run: echo "Test 3"
      - restore_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
      - run:
          name: Build Voice CPP slave
          command: |
            echo "currenr dir: $(pwd)"
            cd ~
            echo "currenr dir-new: $(pwd)"
            mkdir -p test_dir
            echo "test-3" > test_dir/test_file.txt
          shell: /bin/bash
      - save_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
          paths:
            - "~/test_dir"
  check_data_1:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - checkout
      - restore_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
      - run: echo "Test cache"
      - save_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
          paths:
            - "~/test_dir"
      - run:
          name: Check workspace attached
          command: |
            echo "currenr dir: $(pwd)"
            cd ~
            echo "currenr dir-new: $(pwd)"
            cat test_dir/test_file.txt
            if [[ $? -eq 0 ]]; then
                echo "Workspace persisted";
            else
                echo "Workspace did not persist"; exit 1
            fi
  check_data_2:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - checkout
      - restore_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
      - run: echo "Test cache"
      - save_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
          paths:
            - "~/test_dir"
      - run:
          name: Check workspace attached
          command: |
            echo "currenr dir: $(pwd)"
            cd ~
            echo "currenr dir-new: $(pwd)"
            cat test_dir/test_file.txt
            if [[ $? -eq 0 ]]; then
                echo "Workspace persisted";
            else
                echo "Workspace did not persist"; exit 1
            fi
  check_data_3:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - checkout
      - restore_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
      - run: echo "Test cache"
      - save_cache:
          key: -v1-test{{ arch }}-{{ .Revision }}
          paths:
            - "~/test_dir"
      - run:
          name: Check workspace attached
          command: |
            echo "currenr dir: $(pwd)"
            cd ~
            echo "currenr dir-new: $(pwd)"
            cat test_dir/test_file.txt
            if [[ $? -eq 0 ]]; then
                echo "Workspace persisted";
            else
                echo "Workspace did not persist"; exit 1
            fi
workflows:
  version: 2
  test_workspace:
    jobs:
      - set_env_var
      - test_print
      - call_command_1
      - call_command_2
      - call_command_3
      - save_data_2
      - save_data_3
      - check_data_1:
          requires:
            - set_env_var
      - check_data_2:
          requires:
            - save_data_2
      - check_data_3:
          requires:
            - save_data_3
